{% extends 'base.fcc.html.twig' %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('jquery-confirm/jquery-confirm.min.css') }}"
          xmlns="http://www.w3.org/1999/html"/>
    <link rel="stylesheet" href="{{ asset('css/form-wizard.css') }}"/>
{% endblock %}

{% block page_toolbar_left %}
    Batch Re-Validation
{% endblock %}
{% block page_toolbar_right %}
    <a class="btn btn-link close-btn" href="{{ path('submission_status') }}"><i
                class="fa fa-arrow-left"></i></a>
{% endblock %}


{% block main %}
    <div class="row">
        <div class="col-md-12">

            <div class="panel-abc panel-default-abc">
                <div class="panel-body-abc">

                    <div id="first-step" class="step-container" style="min-height: 350px;">
                        <div class="row">
                            <div class="col-md-12 step-instruction">
                                <div style="display: flex;justify-content: center; align-items: center;height: 300px;">

                                    <button id="btn-start-revalidation" class="btn btn-info btn-lg">
                                        <i class="fa fa-refresh" style="font-size: 30px;"></i>
                                        <br/>
                                        Start Batch Re-Validation
                                    </button>

                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="second-step" class="step-container">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="validation-step-container">

                                    <div id="validationProgress" class="validation-stage text-center">
                                        <div class="loader">
                                            <svg class="circular" viewBox="25 25 50 50">
                                                <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="3"
                                                        stroke-miterlimit="10"/>
                                            </svg>
                                        </div>
                                        <br/>
                                        <h5>Please Wait</h5>
                                        <br/><br/>
                                        <div class="validation-analysis" style="font-size: 20px;font-weight: bold;color: #444444;">
                                            <span>Re-Validating: </span>
                                            <span class="total-batch">--</span>
                                            <span style="margin-left: 20px;">Failed: </span>
                                            <span class="total-failed" style="color: #D8350F;">--</span>
                                            <span style="margin-left: 20px;">Passed: </span>
                                            <span class="total-passed" style="color: #34A853;">--</span>
                                        </div>
                                    </div>

                                    <div id="processCompleted" class="validation-stage text-center">
                                        <i class="fa fa-check-circle validation-success-icon"></i>
                                        <br/>
                                        <h5 class="text-success">Process Completed</h5>
                                        <br/>
                                        <a href="{{ path('submission_status') }}" class="btn btn-success">
                                            Continue
                                        </a>
                                        <br/><br/>
                                        <div class="validation-analysis" style="font-size: 20px;font-weight: bold;color: #444444;">
                                            <span>Re-Validating: </span>
                                            <span class="total-batch">--</span>
                                            <span style="margin-left: 20px;">Failed: </span>
                                            <span class="total-failed" style="color: #D8350F;">--</span>
                                            <span style="margin-left: 20px;">Passed: </span>
                                            <span class="total-passed" style="color: #34A853;">--</span>
                                        </div>
                                    </div>

                                    <div id="retry-validation" class="validation-stage text-center">
                                        <i class="fa fa-bolt validation-warning-icon"></i>
                                        <br/>
                                        <h5 class="text-warning">
                                            We are having trouble connecting with our validation service.
                                            <br/>
                                            Check your internet connection and click the button bellow.
                                        </h5>
                                        <br/>
                                        <button id="btn-retry-validation" type="submit" class="btn btn-warning">
                                            Try Again
                                        </button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    {#validation form#}
                    <div id="validation-form-container" class="validation-form-container" style="visibility: hidden;">
                        <div class="row">
                            <div class="col-md-12">
                                <div>
                                    <form method="post" action="{{ path('long_running_federal_nominal_roll_batch_re_validation_scheduler') }}"
                                          id="validationForm"
                                          enctype="multipart/form-data">

                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script type="text/javascript" src="{{ asset('js/jquery.form.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('jquery-confirm/jquery-confirm.min.js') }}"></script>
    <script type="text/javascript">

        $(document).ready(function () {

            var firstStepContainer = $('#first-step');
            var secondStepContainer = $('#second-step');

            var validationProgressContainer = $('#validationProgress');
            var validationProcessCompletedContainer = $('#processCompleted');
            var validationAnalysisContainer = $('.validation-analysis');

            var validationReTryContainer = $('#retry-validation');
            var retryValidationBtn = $('#btn-retry-validation');

            var validationForm = $('#validationForm');

            $('#btn-start-revalidation').on('click', function (event) {
                event.preventDefault();
                //console.log('button clicked');
                validationForm.submit();
                //testJsonEmpty();
            });

            function testJsonEmpty(){
                var obj = {

                };

                if(obj.name != undefined){
                    console.log('object is not empty')
                }else{
                    console.log('object is empty')
                }
            }

            var checkStatusInterval = null;

            //validation form
            validationForm.ajaxForm({
                beforeSubmit: function (formData, jqForm, options) {
                    showValidationStage("progress");
                    updateAnalysis("--", "--", "--");
                    //showValidationStage("analysis");
                    setInterval(pollServer, 45000);
                    return true;
                },
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var reValidationRequestStatus = data.reValidationRequestStatus;
                    if (reValidationRequestStatus == 'OK' || reValidationRequestStatus == 'ALREADY_PROCESSING') {
                        checkStatusInterval = window.setInterval(checkValidationStatus, 7000);
                    } else {
                        showValidationStage("retry");
                    }

                    //showAlert('Confirmation', uploadStatus + ":" + uploadMessage + ":" + submissionId);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    showValidationStage("retry");
                    //console.log(jqXHR.responseText);
                    //showAlert('Error', jqXHR.responseText);
                    //show retry panel
                },
                complete: function (jqXHR, textStatus) {

                }
            });

            retryValidationBtn.on('click', function (event) {
                event.preventDefault();
                validationForm.submit();
            });

            function checkValidationStatus() {
                $.ajax({
                    url: "{{ path('long_running_federal_nominal_roll_batch_re_validation_status_check') }}",
                    dataType: "json",
                    type: "GET"
                }).done(function (data, textStatus, jqXHR) {

                    console.log('data: ' +  JSON.stringify(data));

                    if(data && data.hasOwnProperty("totalBatch")){
                        var totalBatch = data.totalBatch;
                        var totalFailed = data.totalFailed;
                        var totalPassed = data.totalPassed;
                        var totalPending = data.totalPendingReValidation;

                        updateAnalysis(totalBatch, totalFailed, totalPassed);
                        //validationAnalysisContainer.html('<span>' + totalBatch + ',' + totalFailed + ',' + totalPassed + ',' + totalPending + '</span>');

                        if(totalBatch != 0 && totalPending==0){
                            showValidationStage("completed")
                            window.clearInterval(checkStatusInterval);
                        }
                    }else{
                        console.log('data is empty');
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    //console.log(jqXHR.responseText);
                    //show retry panel
                    showAlert('Network Error', jqXHR.responseText);
                }).always(function (jqXHR, textStatus) {

                });
            }

            function updateAnalysis(totalBatch, totalFailed, totalPassed){
                $('.total-batch').text(totalBatch);
                $('.total-failed').text(totalFailed);
                $('.total-passed').text(totalPassed);
            }

            var jcDialog;

            function showAlert(title, content, dialogtype) {
                dialogtype = (typeof dialogtype !== 'undefined') ? dialogtype : 'green';

                if(jcDialog){
                    jcDialog.setTitle(title);
                    jcDialog.setContent(content);
                    jcDialog.setType(dialogtype);
                    if(jcDialog.isClosed()){
                        jcDialog.open();
                    }
                }else{
                    jcDialog = $.alert({
                        title: title,
                        content: content,
                        type: dialogtype
                    });
                    //jcDialog.open();
                }
            }


            //VALIDATION
            function showValidationStage(which) {
                firstStepContainer.hide();
                secondStepContainer.show();

                $('.validation-stage').hide();

                switch (which) {
                    case "progress":
                        validationProgressContainer.show();
                        break;

                    case "completed":
                        validationProcessCompletedContainer.show();
                        break;

                    case "retry":
                        validationReTryContainer.show();
                        break;
                }

            }

            function pollServer() {
                $.get('{{ path('keep_alive') }}', function (resp) {
                    //console.log(resp);
                });
            }

        });

    </script>
{% endblock %}